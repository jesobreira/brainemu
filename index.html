<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Brainf*ck emulator</title>
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.indigo-pink.min.css">
	
	<style type="text/css">
		.card-cell {
			display: flex;
			box-sizing:border-box;
			align-items: center;
			float: left !important;
		}
		#cells {
			overflow-x: scroll;
		}
		.active-cell {
			background: #00ee00;
		}
	</style>
</head>
<body>
	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header
            mdl-layout--fixed-tabs">
	  <header class="mdl-layout__header">
		<div class="mdl-layout__header-row">
		  <!-- Title -->
		  <span class="mdl-layout-title">Brainf*ck emulator</span>
		</div>
	  </header>
	  <main class="mdl-layout__content">
		<section class="">
		  <div class="page-content">
			<center>
			  <div class="mdl-textfield mdl-js-textfield">
				<textarea placeholder="Your BF code here" class="mdl-textfield__input" type="text" rows= "3" id="bfcode" style="width: 100% !important" ></textarea>
				<input type="hidden" id="parsedbf" />
			  </div>
			  <div id="add">
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  +
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  -
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  [
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  ]
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  .
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  ,
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  <
				</button>
				<button class="mdl-button mdl-js-button mdl-button--raised">
				  >
				</button>
			  </div>
			  <br/>
			  <button id="run" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
				Run
			</button>
			<h3 id="output"></h3>
			<br/><br/><br/>
			<h1 style="border: 1px solid black" id="cur"></h1>
			<div id="cells">
				<table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
				  <thead>
					<tr id="cell-names">
					</tr>
				  </thead>
				  <tbody>
					<tr id="cell-values">
					</tr>
				  </tbody>
				</table>
			</div>
			</center>
		  </div>
		</section>
	  </main>
	</div>
	<!-- javascript -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
	<script type="text/javascript">
		Array.prototype.peek = function() {
			return this[this.length-1];
		}
		$(function() {
			window.cells = prompt("Enter the number of cells.\nBy default, Brainfuck specs tells about 30000 cells but you can set a lower number if you don't need that much.", 300);
			for(i = 1; i <= window.cells; i++) {
				$("#cell-names").append('<th id="cell-'+i+'-name">'+i+'</th>');
				$("#cell-values").append('<th id="cell-'+i+'-value">0</th>');
			}
			selectCell(parseInt(window.cells/2));
			
			$("#add button").click(function() {
				$("#bfcode").val($("#bfcode").val()+$(this).text().trim());
			});
			
			$("#run").click(function() {
				$("#parsedbf").val($("#bfcode").val().replace(/[^\+\-\>\<\.\,\[\]]/g, ""));
				for(i = 1; i <= window.cells; i++) {
					$("#cell-"+i+"-value").text("0");
				}
				$("#output").text("");
				var position = 0;
				var curcell = parseInt(window.cells/2);
				var nestedloops = [];
				var mainthread = setInterval(function() {
					var cur = $("#parsedbf").val().substr(position, 1);
					$("#cur").text(cur);
					
					// process
					switch(cur) {
						case '+':
							var val = parseInt($("#cell-"+curcell+"-value").text().trim());
							val++;
							$("#cell-"+curcell+"-value").text(val);
							break;
							
						case '-':
							var val = parseInt($("#cell-"+curcell+"-value").text().trim());
							val--;
							$("#cell-"+curcell+"-value").text(val);
							break;
							
						case '<':
							curcell--;
							selectCell(curcell);
							break;
							
						case '>':
							curcell++;
							selectCell(curcell);
							break;
							
						case '.':
							$("#output").text($("#output").text() + String.fromCharCode(parseInt($("#cell-"+curcell+"-value").text().trim())));
							break;
							
						case ',':
							$("#cell-"+curcell+"-value").text(String(prompt("Insert 1 byte of data:")).charCodeAt(0));
							break;
							
						case '[':
							var delta = 0;
							if(!parseInt($("#cell-"+curcell+"-value").text().trim())) {
								while(true) {
									position++;
									var cur = $("#parsedbf").val().substr(position, 1);
									if(cur=='[') delta++;
									if(cur==']') {
										if(delta)
											delta--;
										else {
											break;
										}
									}
								}
							} else {
								nestedloops.push(position);
							}
							break;
							
						case ']':
							if(parseInt($("#cell-"+curcell+"-value").text().trim())) {
								position = nestedloops.peek();
							} else {
								nestedloops.pop();
							}
							break;
					}
					
					position++;
					
					if($("#parsedbf").val().length < position) {
						clearInterval(mainthread);
						return;
					}
				}, 100);
			});
		});
		
		function selectCell(id) {
			scrollToCell("#cell-"+id+"-name", "#cells");
			$("#cells th").removeClass("active-cell");
			$("#cell-"+id+"-name").addClass("active-cell");
			$("#cell-"+id+"-value").addClass("active-cell");
		}
		
		function scrollToCell(element, parent) {
			element = $(element);
			parent = $(parent);

			var offset = element.offset().left;

			var visible_area_start = parent.scrollLeft();
			var visible_area_end = visible_area_start + parent.innerWidth();
			
			var half = parent.innerWidth()/2;
			if (offset < visible_area_start) {
				parent.animate({scrollLeft: visible_area_start +offset-half}, 100);
				return false;
			} else if (offset > visible_area_end) {
				parent.animate({scrollLeft: visible_area_start +offset-half }, 100);
				return false;

			}
			return true;
		}
	</script>
</body>
</html>
